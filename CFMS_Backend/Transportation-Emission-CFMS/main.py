from flask import Flask, request, jsonify
import joblib
import pandas as pd

app = Flask(__name__)


def preparing_data_for_model_prediction(transportation_data):

    # Format that the model is being trained.
    transportation_data_encoded = {
        'model': 0,
        'engine_size': 0,
        'cylinders': 0,
        'fuel_consumption_comb': 0,
        'vehicle_class_cluster1': 0,
        'vehicle_class_cluster2': 0,
        'vehicle_class_cluster3': 0,
        'vehicle_class_cluster4': 0,
        'vehicle_class_cluster5': 0,
        'vehicle_class_cluster6': 0,
        'fuel_type_E': 0,
        'fuel_type_X': 0,
        'fuel_type_Z': 0
    }

    make_mapping = {'FORD': 0.08504875406283857, 'CHEVROLET': 0.07949620801733477, 'BMW': 0.07137053087757313,
                    'MERCEDES-BENZ': 0.056744312026002164, 'PORSCHE': 0.050920910075839654,
                    'TOYOTA': 0.04469122426868906, 'GMC': 0.044420368364030335, 'AUDI': 0.03873239436619718,
                    'NISSAN': 0.03507583965330444, 'JEEP': 0.033992416034669556, 'DODGE': 0.033315276273022755,
                    'KIA': 0.03128385698808234, 'HONDA': 0.028981581798483206, 'HYUNDAI': 0.028439869989165763,
                    'MINI': 0.0276273022751896, 'VOLKSWAGEN': 0.026679306608884075, 'MAZDA': 0.02437703141928494,
                    'LEXUS': 0.024106175514626217, 'JAGUAR': 0.021668472372697724, 'CADILLAC': 0.021397616468039005,
                    'SUBARU': 0.01895991332611051, 'VOLVO': 0.016793066088840736, 'INFINITI': 0.014626218851570965,
                    'BUICK': 0.01394907908992416, 'RAM': 0.013136511375947995, 'LINCOLN': 0.013001083423618635,
                    'MITSUBISHI': 0.012865655471289273, 'CHRYSLER': 0.011917659804983749,
                    'LAND ROVER': 0.011511375947995667, 'FIAT': 0.009886240520043338, 'ACURA': 0.009750812567713976,
                    'MASERATI': 0.008261105092091008, 'ROLLS-ROYCE': 0.006771397616468039,
                    'ASTON MARTIN': 0.006365113759479957, 'BENTLEY': 0.006229685807150596,
                    'LAMBORGHINI': 0.005552546045503792, 'ALFA ROMEO': 0.004062838569880823,
                    'GENESIS': 0.0033856988082340196, 'SCION': 0.002979414951245937, 'SMART': 0.0009479956663055255,
                    'BUGATTI': 0.00040628385698808235, 'SRT': 0.00027085590465872155}

    model_mapping = {'I series': 0.03114842903575298, 'COOPER': 0.0276273022751896, 'F-150': 0.02586673889490791,
                     'M series': 0.0207204767063922, '911 CARRERA': 0.018147345612134345,
                     'SILVERADO': 0.014219934994582881, 'SIERRA': 0.014084507042253521, 'CHEROKEE': 0.0138136511375948,
                     'X series': 0.012865655471289273, 'YUKON': 0.012730227518959913, 'CHARGER': 0.011917659804983749,
                     '1500': 0.011782231852654389, 'F-TYPE': 0.010021668472372697, 'S': 0.010021668472372697,
                     'MAZDA3': 0.009750812567713976, 'MUSTANG': 0.009750812567713976, 'CIVIC': 0.009615384615384616,
                     'E': 0.009479956663055254, 'RANGE ROVER': 0.009479956663055254, 'CHALLENGER': 0.009073672806067173,
                     'PANAMERA': 0.008396533044420368, 'GOLF': 0.008125677139761646, 'FORTE': 0.007990249187432286,
                     'C': 0.007854821235102925, 'CAMARO': 0.0071776814734561215, 'SONIC': 0.007042253521126761,
                     'COROLLA': 0.006635969664138678, 'COLORADO': 0.006365113759479957, 'CRUZE': 0.006365113759479957,
                     'CTS': 0.006229685807150596, 'COMPASS': 0.006094257854821235, '300': 0.006094257854821235,
                     'ACCORD': 0.006094257854821235, 'FOCUS': 0.005958829902491874, 'TACOMA': 0.005958829902491874,
                     'ELANTRA': 0.005958829902491874, 'EQUINOX': 0.0058234019501625135,
                     'WRANGLER': 0.005687973997833153, '500': 0.005687973997833153,
                     'TRANSIT CONNECT': 0.005687973997833153, 'TAHOE': 0.005552546045503792,
                     'EXPLORER': 0.005417118093174431, 'CAMRY': 0.005417118093174431, 'SUBURBAN': 0.005417118093174431,
                     'CANYON': 0.00528169014084507, 'JETTA': 0.0051462621885157095, 'SANTA FE': 0.0051462621885157095,
                     'BEETLE': 0.005010834236186349, 'TERRAIN': 0.005010834236186349, 'ESCAPE': 0.004875406283856988,
                     'CONTINENTAL': 0.004875406283856988, 'EXPRESS': 0.004739978331527627, 'ATS': 0.004739978331527627,
                     'EDGE': 0.004739978331527627, 'CAYENNE': 0.004739978331527627, 'FUSION': 0.004739978331527627,
                     'CX-5': 0.004739978331527627, 'TAURUS': 0.004604550379198266, 'BOXSTER': 0.0044691224268689055,
                     'CAYMAN': 0.0044691224268689055, 'HIGHLANDER': 0.0044691224268689055, 'S60': 0.004333694474539545,
                     'IMPREZA': 0.004333694474539545, 'FRONTIER': 0.004198266522210184,
                     'RENEGADE': 0.004198266522210184, 'SAVANA': 0.004198266522210184, 'SONATA': 0.004198266522210184,
                     'LANCER': 0.004062838569880823, 'Q50': 0.004062838569880823, 'IS': 0.003927410617551462,
                     '200': 0.003927410617551462, 'PATRIOT': 0.003927410617551462, 'A8': 0.003791982665222102,
                     'SORENTO': 0.003791982665222102, '370Z': 0.003791982665222102, 'RAV4': 0.003791982665222102,
                     'DART': 0.003656554712892741, 'V60': 0.003656554712892741, 'SENTRA': 0.003656554712892741,
                     'OPTIMA': 0.0035211267605633804, '911 TURBO': 0.0035211267605633804,
                     'TUNDRA': 0.0033856988082340196, 'TUCSON': 0.0033856988082340196,
                     'VELOSTER': 0.0033856988082340196, 'CORVETTE': 0.0033856988082340196,
                     'JOURNEY': 0.0033856988082340196, 'SOUL': 0.0032502708559046588, 'ENCORE': 0.0032502708559046588,
                     '911 TARGA': 0.0032502708559046588, 'SPORTAGE': 0.0032502708559046588, 'Q5': 0.0032502708559046588,
                     'GLE': 0.0032502708559046588, 'MKZ': 0.0032502708559046588, 'A4': 0.0032502708559046588,
                     'FIESTA': 0.0032502708559046588, 'REGAL': 0.003114842903575298, 'R8': 0.003114842903575298,
                     'GS': 0.003114842903575298, 'RVR': 0.003114842903575298, 'LACROSSE': 0.003114842903575298,
                     'VANTAGE': 0.003114842903575298, 'ACADIA': 0.003114842903575298, 'XC60': 0.002979414951245937,
                     'YARIS': 0.002979414951245937, 'A5': 0.002979414951245937, 'PHANTOM': 0.002979414951245937,
                     'LS': 0.002979414951245937, 'PATHFINDER': 0.002979414951245937, 'IMPALA': 0.002979414951245937,
                     'RX': 0.0028439869989165764, 'HR-V': 0.0028439869989165764, 'PRIUS': 0.0028439869989165764,
                     'SL': 0.0028439869989165764, 'S5': 0.0028439869989165764, 'Q60': 0.0028439869989165764,
                     'Q70': 0.0027085590465872156, 'TRAX': 0.0027085590465872156, 'ALTIMA': 0.0027085590465872156,
                     'FIT': 0.0027085590465872156, 'RC': 0.0027085590465872156, 'PASSAT': 0.0027085590465872156,
                     'MIRAGE': 0.0027085590465872156, 'GT': 0.0027085590465872156,
                     'QUATTROPORTE': 0.0025731310942578548, 'GHIBLI': 0.0025731310942578548,
                     'MALIBU': 0.0025731310942578548, 'HURACAN': 0.0025731310942578548,
                     'DURANGO': 0.0025731310942578548, 'A3': 0.0025731310942578548, 'WRX': 0.0025731310942578548,
                     'NX': 0.002437703141928494, 'OUTBACK': 0.002437703141928494, 'CX-3': 0.002437703141928494,
                     'FLEX': 0.002437703141928494, 'LEGACY': 0.002437703141928494, 'TLX': 0.002437703141928494,
                     'JUKE': 0.002437703141928494, 'OUTLANDER': 0.002437703141928494, 'RS': 0.002437703141928494,
                     'XTS': 0.002437703141928494, 'MAZDA6': 0.002437703141928494, 'CLA': 0.002302275189599133,
                     'G': 0.002302275189599133, 'T-150': 0.002302275189599133, 'FORESTER': 0.002302275189599133,
                     'A6': 0.002302275189599133, 'TIGUAN': 0.002302275189599133, 'AVENTADOR': 0.002302275189599133,
                     'MACAN': 0.002302275189599133, 'PILOT': 0.002302275189599133, 'CROSSTREK': 0.002302275189599133,
                     'RIO': 0.002302275189599133, 'Z series': 0.0021668472372697724, 'MX-5': 0.0021668472372697724,
                     'XF': 0.0021668472372697724, 'BRZ': 0.0021668472372697724, 'MDX': 0.0021668472372697724,
                     'ES': 0.0021668472372697724, 'MKT': 0.0020314192849404116, 'CLS': 0.0020314192849404116,
                     'TITAN': 0.0020314192849404116, 'TRAVERSE': 0.0020314192849404116, 'QX60': 0.0020314192849404116,
                     'SEDONA': 0.0020314192849404116, 'ROGUE': 0.001895991332611051, 'GLC': 0.001895991332611051,
                     'EXPEDITION': 0.001895991332611051, 'GHOST': 0.001895991332611051, '4RUNNER': 0.001895991332611051,
                     'CT6': 0.001895991332611051, 'SIENNA': 0.001895991332611051, 'D series': 0.001895991332611051,
                     'ENCLAVE': 0.001895991332611051, 'ACCENT': 0.001895991332611051, 'CR-V': 0.001895991332611051,
                     'SPARK': 0.001895991332611051, 'VERSA': 0.001895991332611051, 'TT': 0.001895991332611051,
                     'MURANO': 0.0017605633802816902, 'XC90': 0.0017605633802816902, 'CARAVAN': 0.0017605633802816902,
                     'ESCALADE': 0.0017605633802816902, 'MKC': 0.0017605633802816902, 'VENZA': 0.0016251354279523294,
                     '500L': 0.0016251354279523294, 'ALPINA': 0.0016251354279523294, 'GIULIA': 0.0016251354279523294,
                     'NIRO': 0.0016251354279523294, 'LEVANTE': 0.0016251354279523294, 'QASHQAI': 0.0016251354279523294,
                     'GL': 0.0016251354279523294, 'GLA': 0.0014897074756229686, '500X': 0.0014897074756229686,
                     'G80': 0.0014897074756229686, 'F-PACE': 0.0014897074756229686, 'ILX': 0.0014897074756229686,
                     'NAVIGATOR': 0.0014897074756229686, 'GRANTURISMO': 0.0014897074756229686,
                     'SLK': 0.0014897074756229686, 'CX-9': 0.0014897074756229686, 'Q7': 0.0014897074756229686,
                     'MICRA': 0.0013542795232936078, 'A7': 0.0013542795232936078, '4C': 0.0013542795232936078,
                     'XE': 0.0013542795232936078, 'DISCOVERY': 0.0013542795232936078,
                     'FLYING SPUR': 0.0013542795232936078, 'VERANO': 0.0013542795232936078,
                     '911 GT3': 0.0013542795232936078, 'Q3': 0.0013542795232936078, 'XJR': 0.0013542795232936078,
                     'XJL': 0.0013542795232936078, 'XJ': 0.0013542795232936078, 'B': 0.0013542795232936078,
                     'TTS': 0.001218851570964247, 'GENESIS': 0.001218851570964247, 'ENVISION': 0.001218851570964247,
                     'S4': 0.001218851570964247, 'ODYSSEY': 0.001218851570964247, 'METRIS': 0.001218851570964247,
                     'XT5': 0.001218851570964247, 'RDX': 0.001218851570964247, 'KONA': 0.001218851570964247,
                     'ML': 0.001218851570964247, 'RLX': 0.001218851570964247, 'GLS': 0.001218851570964247,
                     'MAZDA5': 0.0010834236186348862, 'K900': 0.0010834236186348862, 'XKR': 0.0010834236186348862,
                     '124 Spider': 0.0010834236186348862, '86': 0.0010834236186348862, 'V90': 0.0010834236186348862,
                     'STELVIO': 0.0010834236186348862, 'IONIQ': 0.0010834236186348862, 'G90': 0.0010834236186348862,
                     'CC': 0.0010834236186348862, 'MKX': 0.0010834236186348862, 'BLAZER': 0.0009479956663055255,
                     'XC70': 0.0009479956663055255, 'PACIFICA': 0.0009479956663055255,
                     'MULSANNE': 0.0009479956663055255, 'S90': 0.0009479956663055255,
                     'ACTIVEHYBRID': 0.0009479956663055255, 'SLC': 0.0009479956663055255, 'DB11': 0.0009479956663055255,
                     'TOUAREG': 0.0009479956663055255, 'NV200': 0.0009479956663055255, 'LX 570': 0.0009479956663055255,
                     'QX80': 0.0009479956663055255, 'SEQUOIA': 0.0009479956663055255, 'AVALON': 0.0009479956663055255,
                     'GX': 0.0009479956663055255, 'RONDO': 0.0009479956663055255, 'WRAITH': 0.0009479956663055255,
                     'FORTWO': 0.0009479956663055255, 'GT-R': 0.0009479956663055255, 'ARMADA': 0.0008125677139761647,
                     'FR-S': 0.0008125677139761647, 'tC': 0.0008125677139761647, 'ECOSPORT': 0.0008125677139761647,
                     'MKS': 0.0008125677139761647, 'RAPIDE': 0.0008125677139761647, 'VANQUISH': 0.0008125677139761647,
                     'S6': 0.0008125677139761647, 'LC': 0.0008125677139761647, 'G70': 0.0008125677139761647,
                     'S7': 0.0008125677139761647, 'S8': 0.0008125677139761647, 'PROMASTER': 0.0008125677139761647,
                     'QX50 AWD': 0.0008125677139761647, 'CADENZA': 0.0008125677139761647, 'CT5': 0.0008125677139761647,
                     'XFR': 0.0008125677139761647, 'CR-Z': 0.0008125677139761647, 'S3': 0.0008125677139761647,
                     'E150': 0.0008125677139761647, 'TOWN & COUNTRY': 0.0008125677139761647,
                     'MAXIMA': 0.0008125677139761647, 'CT4': 0.0008125677139761647, 'SRX': 0.0008125677139761647,
                     'UX': 0.0006771397616468039, 'SLS': 0.0006771397616468039, 'S80': 0.0006771397616468039,
                     'QX70': 0.0006771397616468039, 'RIDGELINE': 0.0006771397616468039,
                     'BENTAYGA': 0.0006771397616468039, 'ATLAS': 0.0006771397616468039, 'VIPER': 0.0006771397616468039,
                     'C-MAX': 0.0006771397616468039, 'NAUTILUS': 0.0005417118093174431, 'QX30': 0.0005417118093174431,
                     'XTERRA': 0.0005417118093174431, 'CARGO VAN': 0.0005417118093174431, 'XT4': 0.0005417118093174431,
                     'CT': 0.0005417118093174431, 'AVENGER': 0.0005417118093174431, 'A': 0.0005417118093174431,
                     'GLK': 0.0005417118093174431, 'xB': 0.0005417118093174431, 'STINGER': 0.0005417118093174431,
                     'ECLIPSE': 0.0005417118093174431, 'DAWN': 0.0005417118093174431, 'C-HR': 0.00040628385698808235,
                     'CHIRON': 0.00040628385698808235, 'EQUUS': 0.00040628385698808235, 'KICKS': 0.00040628385698808235,
                     'INSIGHT': 0.00040628385698808235, 'TSX': 0.00040628385698808235,
                     'CULLINAN': 0.00040628385698808235, 'LR4': 0.00040628385698808235, 'TL': 0.00040628385698808235,
                     'XC40': 0.00040628385698808235, 'DB9': 0.00040628385698808235, 'E-PACE': 0.00040628385698808235,
                     'E350': 0.00040628385698808235, 'NSX': 0.00040628385698808235, 'PASSPORT': 0.00027085590465872155,
                     'CORSAIR': 0.00027085590465872155, 'RANGER': 0.00027085590465872155,
                     'URUS': 0.00027085590465872155, 'PALISADE': 0.00027085590465872155,
                     'GLADIATOR': 0.00027085590465872155, 'ASCENT': 0.00027085590465872155,
                     'ARTEON': 0.00027085590465872155, 'VENUE': 0.00027085590465872155, 'iQ': 0.00027085590465872155,
                     'Q8': 0.00027085590465872155, 'LR2': 0.00027085590465872155, 'EOS': 0.00027085590465872155,
                     'XK': 0.00027085590465872155, 'ORLANDO': 0.00027085590465872155,
                     'FJ CRUISER 4WD': 0.00027085590465872155, 'DBS': 0.00027085590465872155,
                     'QUEST': 0.00027085590465872155, 'GALLARDO': 0.00027085590465872155, 'iM': 0.00027085590465872155,
                     'xD': 0.00027085590465872155, 'MAZDA2': 0.00027085590465872155, 'CL': 0.00027085590465872155,
                     '911 SPEEDSTER': 0.00013542795232936077, '911 GT2': 0.00013542795232936077,
                     'TRIBECA': 0.00013542795232936077, 'ALLROAD': 0.00013542795232936077,
                     'VENENO': 0.00013542795232936077, 'XT6': 0.00013542795232936077, 'VOYAGER': 0.00013542795232936077,
                     'CROSSTOUR': 0.00013542795232936077, 'TELLURIDE': 0.00013542795232936077,
                     'AVIATOR': 0.00013542795232936077, 'ROUTAN': 0.00013542795232936077,
                     'GR SUPRA': 0.00013542795232936077}

    vehicle_class_mapping = {'COMPACT': 'cluster0', 'FULL-SIZE': 'cluster0', 'MID-SIZE': 'cluster0',
                             'MINICOMPACT': 'cluster0', 'MINIVAN': 'cluster2', 'PICKUP TRUCK - SMALL': 'cluster2',
                             'PICKUP TRUCK - STANDARD': 'cluster6', 'SPECIAL PURPOSE VEHICLE': 'cluster3',
                             'STATION WAGON - MID-SIZE': 'cluster0', 'STATION WAGON - SMALL': 'cluster3',
                             'SUBCOMPACT': 'cluster0', 'SUV - SMALL': 'cluster3', 'SUV - STANDARD': 'cluster6',
                             'TWO-SEATER': 'cluster5', 'VAN - CARGO': 'cluster1', 'VAN - PASSENGER': 'cluster4'}

    # Preparing data for sending it to the Transportation Model.
    # transportation_data_encoded['make'] = make_mapping[transportation_data['vehicleMake']]
    transportation_data_encoded['model'] = model_mapping[transportation_data['vehicleModel']]
    transportation_data_encoded['engine_size'] = transportation_data['engineSize']
    transportation_data_encoded['cylinders'] = transportation_data['cylinders']
    transportation_data_encoded['fuel_consumption_comb'] = transportation_data['fuelConsumption']

    if transportation_data['fuelType'] == "E":
        transportation_data_encoded['fuel_type_E'] = 1
    elif transportation_data['fuelType'] == "X":
        transportation_data_encoded['fuel_type_X'] = 1
    elif transportation_data['fuelType'] == "Z":
        transportation_data_encoded['fuel_type_Z'] = 1

    vehicle_class_cluster = vehicle_class_mapping[transportation_data['vehicleClass']]

    if vehicle_class_cluster == "cluster1":
        transportation_data_encoded['vehicle_class_cluster1'] = 1
    elif vehicle_class_cluster == "cluster2":
        transportation_data_encoded['vehicle_class_cluster2'] = 1
    elif vehicle_class_cluster == "cluster3":
        transportation_data_encoded['vehicle_class_cluster3'] = 1
    elif vehicle_class_cluster == "cluster4":
        transportation_data_encoded['vehicle_class_cluster4'] = 1
    elif vehicle_class_cluster == "cluster5":
        transportation_data_encoded['vehicle_class_cluster5'] = 1
    elif vehicle_class_cluster == "cluster6":
        transportation_data_encoded['vehicle_class_cluster6'] = 1


    return transportation_data_encoded



# Define a route for the POST request
@app.route('/transportationEmissionPrediction', methods=['POST'])
def post_endpoint():

    # Get transportation data from the request
    transportation_data = request.json

    # Transforming transportation data into a format that can be fed into the model
    transportation_data_encoded = preparing_data_for_model_prediction(transportation_data)

    # Perform prediction based on transportation_data_encoded
    # Here you would implement your prediction logic using the provided data

    # Converting transportation_data_encoded to DataFrame
    transportation_data_encoded_df = pd.DataFrame([transportation_data_encoded])

    # Load the saved model
    model = joblib.load("Transportation_Model.pkl")

    # Predict using the model
    predicted_co2_emission = model.predict(transportation_data_encoded_df).iloc[0]

    # Convert the predicted CO2 emission to an integer
    predicted_co2_emission = int(predicted_co2_emission)

    # Return the predicted CO2 emission values as a JSON response
    return jsonify({'co2Emission': predicted_co2_emission})


if __name__ == '__main__':
    app.run(debug=True)
